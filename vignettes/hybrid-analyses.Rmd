---
title: "Hybrid (Individual level and group/level) MHF COVID-19 Analyses"
author: "Zachary Levine"
date: "`r Sys.Date()`"
output: pdf_document
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


### Individual level variables of interest
1. Met minutes
1. Age

##Group level variables of interest.
1. Volume of visits
1. Attendance
1. %Females

We'll be using the automatic ARIMA model fitting machinery from the *forecast* package to simplify this a bit.

```{r}
library(lubridate)
library(forecast)
library(rstatix)
```

First let's generate the three data frames of interest; mets, prescheduled appointments (volume), and noshows. Split each into only appointments in 2019 and only appointments in 2020.
```{r}

##Change the year to select the year
splitbyyear <- function(df, year = "2019"){
  df[lubridate::year(df$Date) == year,]
}
mets2019 <- splitbyyear(RMHF::read_individual_data(fn = "mets.csv"), "2019")
mets2020 <- splitbyyear(RMHF::read_individual_data(fn = "mets.csv"), "2020")

volume2019 <- splitbyyear(RMHF::read_individual_data(fn = "volume.csv"), "2019")
volume2020 <- splitbyyear(RMHF::read_individual_data(fn = "volume.csv"), "2020")
```

Now, let's split off into seperate analyses for each variable. For each, we ask two questions:
1. Does 2019 differ from 2019?
1. If that difference exists, is it before and after the implementation of COVID-19 social distancing in Ontario?

####  Met minutes

First, try fitting ARIMA models. Then do more things.
```{r}
##Should do the heavy lifting for us.
aggregate_date <- function(date, df, colselect = "Mets"){
  dfdate <- df[df$Date == date, colselect]
  return(mean(dfdate))
}
##Vectorized, gives data at the daily level.
meanmets2020 <- sapply(unique(mets2020$Date), aggregate_date, df = mets2020)
meanmets2019 <- sapply(unique(mets2019$Date), aggregate_date, df = mets2019)
meanage2020 <- sapply(unique(volume2020$Date), aggregate_date, df = volume2020, colselect = "Age")
meanage2019 <- sapply(unique(volume2019$Date), aggregate_date, df = volume2019, colselect = "Age")


##Normal stuff, t - test controlling for year.
t.test(meanmets2020, meanmets2019[1:length(meanmets2020)], paired = TRUE)
testdf <- data.frame("covidyear" = meanmets2020,
                     ##Could control for, depending on independence. assumption
                     "age" = meanage2020[1:length(meanmets2020)],
                     "covid" = c(rep(0,8), rep(1,26)))
anova_test(data = testdf, 
           formula = covidyear ~ covid)
```

####  Age

```{r}
auto.arima(meanage2020)
auto.arima(meanage2019)
```

####  Attendance

```{r}
RMHF::read_group_data()


```


####  %Females

```{r}

```

## Correlations between attendance and met-minutes.

```{r}
mets2020 <- RMHF::read_group_data()[RMHF::read_group_data()$Year == "2020",]$"Met-minutes"
mets2019 <- RMHF::read_group_data()[RMHF::read_group_data()$Year == "2019",]$"Met-minutes"
att2020 <- RMHF::read_group_data()[RMHF::read_group_data()$Year == "2020",]$"% of patients who were no-shows"
att2019 <- RMHF::read_group_data()[RMHF::read_group_data()$Year == "2019",]$"% of patients who were no-shows"

#The ith element in meanmets is the mean of the mets collected on ith day in that year.
cor(as.numeric(mets2019), as.numeric(att2019))
cor(as.numeric(mets2020), as.numeric(att2020))
```
